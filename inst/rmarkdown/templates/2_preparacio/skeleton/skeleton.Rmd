---
title: 'Analisis transversal descriptivo . Fecha de corte:  `r params$bd.dindex1`'
author: "Jordi Real & Rai Puig"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_desti: "dades"
  ANY: '20181231'
---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

## Fase Preparacio

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

gc()
# libreries i funcions
library("dplyr")
library("lubridate")
library("compareGroups")


# Descarregar funcions github -
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# Llegir plana
dt_plana<-readRDS(here::here(params$dir_dades_desti,"dt_plana1.rds")) %>% as_tibble()


```
## Recodificaciones   Na 

```{r recodificacions Na }

# Convertim les variables categòriques  Na o 0 --> 0, la resta 1  !!!!! ( no hi haurà missings!!)

dt_plana<-mutate_at(dt_plana, vars( starts_with("INCLUSIO.") ), funs( if_else(.==0  | is.na(.)  ,0,1)))

dt_plana<-mutate_at(dt_plana, vars( starts_with("DG.") ), funs( if_else(.==0  |  is.na(.)  ,0,1)))
dt_plana<-mutate_at(dt_plana, vars( starts_with("EVENT.") ), funs( if_else(.==0  |  is.na(.)  ,0,1)))

dt_plana<-mutate_at(dt_plana, vars( starts_with("FF.") ), funs( if_else(.==0  | is.na(.)  ,0,1)))
dt_plana<-mutate_at(dt_plana, vars( starts_with("FP.") ), funs( if_else(.==0  | is.na(.)  ,0,1)))


```


## Recodificacions i calculs [Part demografica: dt_poblacio,dt_tabaquisme]

```{r recodificacions1 }

#general

#1)EDAT
dt_plana<-dt_plana %>% mutate(age=as.numeric(lubridate::ymd(dtindex)-lubridate::ymd(dnaix))/365.25)
#2)EDAT-->age2.cat: <30,[30-56),[56-75),>=75
#dt_plana<-dt_plana %>% mutate(age2.cat=case_when(age<30~ 1,
#                                                 age>=30 & age<56 ~ 2,
#                                                 age>=56 & age<75 ~ 3,
#                                                 age >=75~ 4 ))

dt_plana<-dt_plana %>% mutate(age2.cat=case_when(age<30~ "age<30",
                                                 age>=30 & age<56 ~ "age>=30 & age<56",
                                                 age>=56 & age<75 ~ "age>=56 & age<75",
                                                 age >=75~ "age >=75" ))



#3)EDAT-->age2.cat: <56),[56-75),>=75
#dt_plana<-dt_plana %>% mutate(age3.cat=case_when(age<56 ~ 1,
#                                                 age>=56 & age<75 ~ 2,
#                                                 age >=75~ 3 ))


#4)EDAT-->age3.cat-><30,[30-40),[40-50),[50-60),[60-70),[70-80),>=80
#dt_plana<-dt_plana%>%mutate(age4.cat=case_when(     age<30~ 1,
#                                                    age>=30 & age<40 ~ 2,  
#                                                    age>=40 & age<50 ~ 3,
#                                                    age>=50 & age<60 ~ 4,
#                                                    age>=60 & age<70 ~ 5,
#                                                    age>=70 & age<80 ~ 6,
#                                               age>=80~ 7 ))


#5)Grups d'edat per cada 5 anys desde 20 fins major de 90
#dt_plana<-dt_plana%>% mutate(age5.cat=cut2(age,seq(20,90,5),right = F))
#dt_plana<-dt_plana%>% mutate(ruralitat=if_else(ruralitat=="","ND",ruralitat))


#6)
#dt_plana<-dt_plana%>% mutate(age6.cat=case_when(age<75~0,age >=75~ 1))
#dt_plana<-dt_plana%>% mutate(age7.cat=case_when(age<=75~0,age >75~ 1))


#7)Temps_evolucio->TEMPS EVOLUCIO DM2
#dt_plana<-dt_plana%>%mutate(temps_evolucio=(ymd(dtindex)-ymd(DG.DM2)),temps_evolucio=round(temps_evolucio/365.25,2)%>% as.numeric()) 
#dt_plana<-dt_plana%>%mutate(DATA_DM2=INCLUSIO.DM2)


#8)Temps d'evolució de la malaltia_categorica-->temps_evolucio_cat:<5,[5-11),[11-20),>=20.
#dt_plana<-dt_plana%>%mutate(temps_evolucio_cat=case_when(
#                                                      temps_evolucio<5~ 1,
#                                                      temps_evolucio   >=5 &   temps_evolucio   <11 ~ 2,  
#                                                      temps_evolucio   >=11 &   temps_evolucio   <20 ~ 3,
#                                                      temps_evolucio>=20  ~ 4))


#9)Temps evolucó diabetis, fer nova categorització , menys de 5 anys, entre 5 i 15 anys i de 50 i més anys d'evolució.
#dt_plana<-dt_plana%>%mutate(temps_evolucio_cat2=case_when(
#                                                      temps_evolucio<5~ 1,
#                                                      temps_evolucio   >=5 &   temps_evolucio   <15 ~ 2,  
#                                                      temps_evolucio>=15  ~ 3))


#10)Temps evoluciO diabetis, fer nova categorització , menys de 5 anys, entre 5 i 19 anys i de 20 i més anys d'evolució.
#dt_plana<-dt_plana%>%mutate(temps_evolucio_cat3=case_when(
#                                                      temps_evolucio<5~ 1,
#                                                      temps_evolucio   >=5 &   temps_evolucio   <20 ~ 2,  
#                                                      temps_evolucio>=20  ~ 3))


#11)Temps evoluciO diabetis, fer nova categoritzacio , menys de 5 anys, i mes 5 anys d'evolució.
#dt_plana<-dt_plana%>%mutate(temps_evolucio_cat4=case_when(
#                                                      temps_evolucio<5   ~ 1,
#                                                      temps_evolucio>=5  ~ 2))

#12)Tabac Categoric.
dt_plana<-dt_plana%>% mutate(tabac2=case_when(tabac.valor==0~"1.   No Fumador",
                                              tabac.valor==1~"2.   Fumador",
                                              tabac.valor==2~"3.   Exfumador"))





```


## Recodificacions i calculs [Part Diagnostics: dt_diagnostics_AP_HOSP]

```{r recodificacions2}
###Problemes de Salut##



#1)Neuropatia periferica : diagnostico registrado o el valor de monofilamento
#dt_plana<-dt_plana%>%mutate(DG.NEUROPT2=ifelse(DG.NEUROPT==1,1,0)) 




```
## Recodificacions i calculs [Part FARMACS: dt_facturacio,dt_prescripcio]

```{r recodificacions3}

## FARMACS:: Tractaments##

#------------------------------#
#i)     ADO->FF.Ado
#------------------------------#
#1.     FF.Biguanidas     
#2.     FF.Sulfonilureas
#3.     FF.Glinides
#4.     FF.Tiazolidinadiones 
#5.     FF.ISGLT2
#6.     FF.IDPP4  
#7.     FF.OtrAntidiabOrales 
#8.     FF.InAlfaGluc
#9.     FF.Combinaciones 


#------------------------------#
#ii)    INSULINAS->FF.Insul
#------------------------------#
#1.     FF.InAccInt           
#2.     FF.InAccLenta         
#3.     FF.InAccRapida  
#4.     FF.InMixta  


#------------------------------#
#iii)   ADO+INSULINAS-->FF.Ado+FF.Insul
#------------------------------#
#1.     i)     ADO          
#2.     ii)    INSULINAS


```


## Recodificacions i calculs [Part dt_variables: dt_analitiques,dt_cliniques]

```{r recodificacions4}
###V.Analitiques+V.Cliniques.##


#2)Index de Massa Corporal->IMC.valor_cat: <15,[15-25),[25-30),>=30
#dt_plana<-dt_plana%>%mutate(IMC.valor_cat=case_when(IMC.valor   <15~ 1,
#                                                    IMC.valor   >=15 & IMC.valor   <25 ~ 2,  
#                                                    IMC.valor   >=25 & IMC.valor   <30 ~ 3,
#                                                    IMC.valor   >=30  ~ 4))


#2)Index de Massa Corporal->IMC.valor_cat: <15,[15-25),[25-30),>=30
dt_plana<-dt_plana%>%mutate(IMC.valor_cat=case_when(IMC.valor   <15~ "IMC.valor   <15",
                                                    IMC.valor   >=15 & IMC.valor   <25 ~ "IMC.valor   >=15 & IMC.valor",  
                                                    IMC.valor   >=25 & IMC.valor   <30 ~ "IMC.valor   >=25 & IMC.valor   <30",
                                                    IMC.valor   >=30  ~ "IMC.valor   >=30"))




#3)Index de Massa Corporal->IMC.valor_cat2: <18.5,[18.5-25),[25-30),>=30.
#dt_plana<-dt_plana%>%mutate(IMC.valor_cat2=case_when(  IMC.valor   <18.5~ 1,
#                                                      IMC.valor   >=18.5 & IMC.valor   <25 ~ 2,  
#                                                      IMC.valor   >=25 & IMC.valor   <30 ~ 3,
#                                                      IMC.valor   >=30  ~ 4))

#4)PAS_PAD
#dt_plana<-dt_plana%>%mutate(PAS_PAD1b=case_when(     (PAS.valor<90  & PAD.valor<60)~                                      "1.[PAS<90 i PAD<60]",      
#                                                     (PAS.valor>=140 | PAD.valor>=90)~                                    "4.[PAS>=140 O PAD>=90]",     
#                                                     (PAS.valor>=120 & PAS.valor<140) | (PAD.valor>=80 & PAD.valor<90) ~  "3.[PAS:[120-140) o PAD:[80-90)]",
#                                                     (PAS.valor>=90 & PAS.valor<120)  | (PAD.valor>=60 & PAD.valor<80) ~  "2.[PAS:[90-120) o PAD:[60-80)]" )) 


#11)COLESTEROL TOTAL: cT.valor               
#dt_plana<-dt_plana%>%mutate(cT.valor_CAT=case_when(  COLTOT.valor     <200~ 1,
#                                                     COLTOT.valor     >=200 & COLTOT.valor     <=240 ~ 2,  
#                                                     COLTOT.valor     >240  ~ 3))

#11)COLESTEROL TOTAL: cT.valor               
dt_plana<-dt_plana%>%mutate(cT.valor_CAT=case_when(  COLTOT.valor     <200~ "COLTOT.valor     <200",
                                                     COLTOT.valor     >=200 & COLTOT.valor     <=240 ~ "COLTOT.valor     >=200 & COLTOT.valor     <=240 ",  
                                                     COLTOT.valor     >240  ~ " COLTOT.valor     >240"))



#12)COLESTEROL HDL
#dt_plana<-dt_plana%>%mutate(cHDL.valor_CAT=case_when(COLHDL.valor        <45~ 1,
#                                                     COLHDL.valor        >=45 & COLHDL.valor        <=90 ~ 2,  
#                                                     COLHDL.valor        >90  ~ 3))

#12)COLESTEROL HDL
dt_plana<-dt_plana%>%mutate(cHDL.valor_CAT=case_when(COLHDL.valor        <45~ "COLHDL.valor        <45",
                                                     COLHDL.valor        >=45 & COLHDL.valor        <=90 ~ "COLHDL.valor        >=45 & COLHDL.valor        <=90",  
                                                     COLHDL.valor        >90  ~ "COLHDL.valor        >90"))



#13)COLESTEROL LDL LDL.COLESTEROL.LDL, (<70, <100, >100, >130) 
#dt_plana<-dt_plana%>%mutate(cLDL.valor_CAT=case_when(COLLDL.valor        <70~ 1,
#                                                     COLLDL.valor        >=70 & COLLDL.valor        <130 ~ 2,  
#                                                     COLLDL.valor        >=130  ~ 3))


#13)COLESTEROL LDL LDL.COLESTEROL.LDL, (<70, <100, >100, >130) 
dt_plana<-dt_plana%>%mutate(cLDL.valor_CAT=case_when(COLLDL.valor        <70~ "COLLDL.valor        <70",
                                                     COLLDL.valor        >=70 & COLLDL.valor        <130 ~ "COLLDL.valor        >=70 & COLLDL.valor        <130",  
                                                     COLLDL.valor        >=130  ~ "COLLDL.valor        >=130"))



#14)COLESTEROL LDL LDL.COLESTEROL.LDL, <70 , 70-99, 100-129 y >o=130
#dt_plana<-dt_plana%>%mutate(cLDL.valor_CAT2=case_when(COLLDL.valor       <70~ 1,
#                                                     COLLDL.valor        >=70 & COLLDL.valor        <100 ~ 2,
#                                                     COLLDL.valor        >=100 & COLLDL.valor        <130 ~ 3,
#                                                     COLLDL.valor        >=130  ~ 4))



#30)
#dt_plana<-dt_plana%>%mutate(PAS_PAD3=case_when(       PAS.valor<140 & PAD.valor<90~ 1,
#                                                      PAS.valor>=140 & PAD.valor>=90~ 2)  )

#31)
#dt_plana<-dt_plana%>%mutate(PAS_PAD4=case_when(       PAS.valor<=140 & PAD.valor<=90~ 1,
#                                                      PAS.valor>140 & PAD.valor>90~ 2)  )





```

## Recodificacions i calculs [combinacions:Part Diagnostics+Part FARMACS+Part dt_variables]

```{r recodificacions5}
## Combinacions ##


#dt_plana<-dt_plana%>%mutate(DG.HTA2=ifelse(DG.HTA==1  | FF.Hipotensores==1 ,1,0)) 

#1)
#dt_plana<-dt_plana%>%mutate(DG.HTA2=ifelse(DG.HTA==1  |
#                                            FF.Hipotensores_altres ==1  |                   
#                                            FF.Hipotensores_ANTICA ==1  |                    
#                                            FF.Hipotensores_ARA    ==1  |                      
#                                            FF.Hipotensores_BBK    ==1  |                    
#                                            FF.Hipotensores_DIU    ==1  |                      
#                                            FF.Hipotensores_IECA ,1,0)) 
#2)HIPERCOLESTEROLEMIA

#* HIPERCOLESTEROLEMIA #
##Hipercolesterolemia diagnostico registrado o tto hipolipemiante
#"FF.Hipolipemiantes_altres"                 
#"FF.Hipolipemiantes_ESTA"                  
#"FF.Hipolipemiantes_EZE"                    
#"FF.Hipolipemiantes_FIB"   
#dt_plana<-dt_plana%>%mutate(DG.Hipercol2=ifelse(DG.HCOL==1  | FF.Hipolipemiantes==1 ,1,0)) 



```


## Recodificacions de zeros i uns nous+dates


```{r recodificacions6}



#dt_plana<-mutate_at(dt_plana, vars( starts_with("LDL_PP_") ), funs( if_else(.==0  | is.na(.)  ,0,1)))
#dt_plana<-mutate_at(dt_plana, vars( starts_with("LDL_PS_") ), funs( if_else(.==0  | is.na(.)  ,0,1)))

dt_plana<-dt_plana%>% mutate_at(c("dnaix","entrada","sortida" ),ymd)



```

## Recodificaciones temporals

```{r recodificacions temporals}


# my.max <- function(x) ifelse( !all(is.na(x)), max(x, na.rm=T), NA)


#dt_plana<-dt_plana %>%
#             group_by(idp)%>%mutate(DG.UEIPA.365.ULCERA_PIE=sum(DG.UEIPA.365.ULC_MI_CMBD,
#                                                                DG.UEIPA.365.ULC_MI_CMBD_NE,
#                                                                DG.UEIPA.365.ULC_MI,na.rm=T))%>%ungroup()


#dt_plana<-dt_plana %>%
#             group_by(idp)%>%mutate(DG.UEIPA.INF.ULCERA_PIE=sum(DG.UEIPA.INF.ULC_MI_CMBD,
#                                                                DG.UEIPA.INF.ULC_MI_CMBD_NE,
#                                                                DG.UEIPA.INF.ULC_MI,na.rm=T))%>%ungroup()


#dt_plana<-dt_plana %>%
#             group_by(idp)%>%mutate(DG.UEIPA.INF_365.ULCERA_PIE=sum(DG.UEIPA.INF_365.ULC_MI_CMBD,
#                                                                DG.UEIPA.INF_365.ULC_MI_CMBD_NE,
#                                                                DG.UEIPA.INF_365.ULC_MI,na.rm=T))%>%ungroup()


#K1<-dt_plana%>%select(idp,DG.UEIPA.365.ULCERA_PIE, DG.UEIPA.365.ULC_MI_CMBD,DG.UEIPA.365.ULC_MI_CMBD_NE,DG.UEIPA.365.ULC_MI)
#K2<-dt_plana%>%select(idp,DG.UEIPA.INF.ULCERA_PIE,DG.UEIPA.INF.ULC_MI_CMBD,DG.UEIPA.INF.ULC_MI_CMBD_NE,DG.UEIPA.INF.ULC_MI)
#K3<-dt_plana%>%select(idp,DG.UEIPA.INF_365.ULCERA_PIE,DG.UEIPA.INF_365.ULC_MI_CMBD,DG.UEIPA.INF_365.ULC_MI_CMBD_NE,DG.UEIPA.INF_365.ULC_MI)



#--------------------------------------------------------------------------------------------------------------#
#v)**RECONVERIR-HO A DATES a "dnaix","entrada","sortida"
#--------------------------------------------------------------------------------------------------------------#


#dt_plana<-dt_plana%>% mutate_at(c("dnaix","entrada","sortida" ),ymd)



#---------------------------------------------------------------------------------------------------------------#
#iii)**#dt_plana<-dt_plana%>%mutate(PAS_PAD=PAS.valor/PAD.valor)
#---------------------------------------------------------------------------------------------------------------#

#eps!!!  ERROR!!?

#tanto missing para PAS/ PAD 
#es una de las variable que se recoge mejor en la bbdd 97.02% de prevalencia!!!
#PAS/PAD: 6465
#1. < 90/60 3 (0.05%)
#2. [90/60-120/80) 520 (8.04%)
#3. [120/80-140/90) 983 (15.2%)
#4. >=140/90 210 (3.25%)
#'Missing' 4749 (73.5)


# ho far? d'aquesta manera:
#1 PAS  <90               OR       PAD <60 
#2 PAS [>=90  and <120]   OR       PAD [>=60 and <80]
#3 PAS [>=120 and <140]   OR       PAD [>=80 and <90]
#4 PAS  >=140             OR       PAD >=90


#Ray, debería ser con AND no con OR,


#PAS_PAD2
#
#dt_plana<-dt_plana%>%mutate(PAS_PAD2=case_when(
#
#                                                     
#
#                                                     (PAS.valor<90 and PAD.valor<60~ 1),
#
#                                                     (PAS.valor>=90 & PAS.valor<120) and (PAD.valor>=60 & PAD.valor<80) ~ 2,
#                                                     (PAS.valor>=120 & PAS.valor<140) and (PAD.valor>=80 & PAD.valor<90) ~ 3,
#                                                      (PAS.valor>=140 and PAD.valor>=90~ 4
#
#))

#Ahora falta la categoría:
#(PAS.valor<140 and PAD.valor<90~ 1
#(PAS.valor>=140 and PAD.valor>=90~ 2

                                                               

#################################
# eps rectificat!: #[12.07.2021]#
#################################


#
#dt_plana<-dt_plana%>%mutate(PAS_PAD1=case_when(     PAS.valor<90  & PAD.valor<60~ 1,
#                                                    PAS.valor>=140 | PAD.valor>=90~ 4,     
#                                                    (PAS.valor>=120 & PAS.valor<140) | (PAD.valor>=80 & PAD.valor<90) ~ 3,
#                                                    (PAS.valor>=90 & PAS.valor<120) | (PAD.valor>=60 & PAD.valor<80) ~ 2  ))
#                                                     
#
#
#
#dt_plana<-dt_plana%>%mutate(PAS_PAD2=case_when(     PAS.mean<90  & PAD.mean<60~ 1,
#                                                    PAS.mean>=140 | PAD.mean>=90~ 4,     
#                                                    (PAS.mean>=120 & PAS.mean<140) | (PAD.mean>=80 & PAD.mean<90) ~ 3,
#                                                    (PAS.mean>=90 & PAS.mean<120) | (PAD.mean>=60 & PAD.mean<80) ~ 2 ))
#                                                     

#(PAS<140 & PAS>120) | (PAD<90 & PAD>80) --> 3
#(PAS<120 & PAS>90) | (PAD<80 & PAD>60) --> 2


#

                                                   

#[18.02.2022]
  
#dt_plana<-dt_plana%>%mutate(PAS_PAD2b=case_when(     (PAS.mean<90  & PAD.mean<60)~                                        "1.[PAS<90 i PAD<60]",      
#                                                     (PAS.mean>=140 | PAD.mean>=90)~                                      "4.[PAS>=140 O PAD>=90]",     
#                                                     (PAS.mean>=120 & PAS.mean<140) | (PAD.mean>=80 & PAD.mean<90) ~      "3.[PAS:[120-140) o PAD:[80-90)]",
#                                                     (PAS.mean>=90 & PAS.mean<120)  | (PAD.mean>=60 & PAD.mean<80) ~      "2.[PAS:[90-120) o PAD:[60-80)]" )) 




#dt_plana<-dt_plana%>%mutate(PAS_PAD2b=case_when(      PAS.valor<90  & PAD.valor<60~ 1,
#                                                      PAS.valor>=140 | PAD.valor>=90~ 4,
#                                                     between(PAS.valor,90,119.9999)  | between(PAD.valor,60,79.9999) ~ 2, 
#                                                     between(PAS.valor,120,140) | between(PAD.valor,80,90) ~ 3
#                                                     ))  
#


#df <- data.frame(ID = c(1:7),
#                 Systolic = c(130,118,120,115,184,114,95),
#                 Diastolic = c(80,76,80,74,107,69,72))
#
#df <- df %>%
#      mutate(BPLevel = case_when(Systolic < 120 | Diastolic < 80 ~ "Normal",
#                                 between(Systolic, 120, 139) | between(Diastolic, 80, 89)~ "Prehypertension",
#                                 Systolic>=140 | Diastolic >= 90 ~ "Hypertension",
#                                 TRUE ~ "Missing"
#                                 ))









#PROVA<-dt_plana%>%select(idp,PAS.valor,PAD.valor,PAS_PAD2)



#2013,2012,2011,2010,2009,2008.......[falla FF.ISGLT2!!]

#6.4.2021 nom?s Insulina!          
#dt_plana<-dt_plana%>%mutate(monoInsulina_c=ifelse(count_NIAD_ADO==0 & FF.Insul==1 ,1,0))
#dt_plana<-dt_plana%>%mutate(poliInsulina_c=ifelse(count_NIAD_ADO>=1 & FF.Insul==1 ,1,0))




#6.4.2021 sense Insulina!
#dt_plana<-dt_plana%>%mutate(count_NIAD_ADO=ifelse(FF.Insul==1 ,0,count_NIAD_ADO))
#

#table(dt_plana$count_NIAD): mirar-ho!! count_NIAD_ADO>=1 | FF.Insul==1~ 6




################################################
# finestra 1 any! 365 dies,                   ##
################################################
#
#
#30.3.2021
#




#dt_plana<-dt_plana%>%mutate(count_NIAD_ADO_365=(  F365.Biguanidas+
#                                                  F365.Sulfonilureas+
#                                                  F365.Glinides+
#                                                  F365.Tiazolidinadiones+
#                                                  F365.ISGLT2+
#                                                  F365.IDPP4+
#                                                  F365.OtrAntidiabOrales+
#                                                  F365.InAlfaGluc+
#                                                  F365.aGLP1))
                                                


#

#table(dt_plana$count_NIAD)
#dt_plana<-dt_plana%>% mutate(count_NIAD_ADO_CAT_365=case_when(
#                                                      count_NIAD_ADO_365==0 & F365.Insul==0 ~0,
#                                                      count_NIAD_ADO_365==1 & F365.Insul==0~ 1,
#                                                      count_NIAD_ADO_365==2 & F365.Insul==0~ 2,
#                                                      count_NIAD_ADO_365>=3 & F365.Insul==0~ 3,
#                                                      count_NIAD_ADO_365==0 & F365.Insul==1~ 4,
#                                                      count_NIAD_ADO_365>=1 & F365.Insul==1~ 5))



#dt_plana<-dt_plana%>% mutate(INSUL_365=F365.Insul)



#dt_plana<-dt_plana%>%mutate(count_Antidiabeticos_365=F365.Biguanidas+
#                              F365.Sulfonilureas+
#                              F365.Glinides+
#                              F365.Tiazolidinadiones+
#                              F365.ISGLT2+
#                              F365.IDPP4+
#                              F365.OtrAntidiabOrales+
#                              F365.InAlfaGluc+
#                              F365.aGLP1+F365.Insul)
 


#dt_plana<-dt_plana%>% mutate(count_Antidiabeticos_CAT_365=case_when(count_Antidiabeticos_365==0~0,count_Antidiabeticos_365>=1~ 1))





# a prtir dels grups!!

#els valors de mitjana dhemoglobina glicada per cada un dels esglaons que us he comentat previament
#(no-drugs, monoterapia, 
#combinada ADNIS, insulina sola i insulina en combinaci? amb ADNIS) que son #dades que ja 
#No se si es molt demanar que ho calculeu, po ser 


# ?  a BOGDAN 

# count_NIAD:0 ?
# count_NIAD:1
# count_NIAD:2
# insulina sola: FF.Insul
# insulina en combinaci? amb ADNIS: FF.Insul+FF.Niad

#[30.3.2021]

#[06.04.2021]
###################################################################################
#Els percentatges haurien de ser sobre el total de pacients de cada fila (PP o PS)#
###################################################################################

#INDICADOR CONJUNTO (HBA1C, PA, LDL) SEGONS PP O PS I
#Con Criterios para PA y HbA1c <  (PP1 y PS1) o bien  < o = (PP2 y PS2) y con LDL<130 en PP y <100 en PS
#

# QUAN TENIM "&" , quan hi ha un missing, tot ?s missing!, per aix? aquest 52 casos!!!.


#dt_plana<-dt_plana%>%mutate(PAS_PAD3=case_when(       PAS.valor<140 & PAD.valor<90~ 1,
#                                                      PAS.valor>=140 & PAD.valor>=90~ 2)  )

#dt_plana<-dt_plana%>%mutate(PAS_PAD4=case_when(       PAS.valor<=140 & PAD.valor<=90~ 1,
#                                                      PAS.valor>140 & PAD.valor>90~ 2)  )


# per separat:!!!

#8.4.2021:

#???? BOGDAN: entendre-ho!!

#GAireb? si:  PS (prev secundaria) son  els que tenen MCV 
#i en els que apliquem el criteri mes estricte de LDL<100
#i els de PP (prev primaria) el criteri de LdL<130 (menys estricte perque tenen menys risc CV).
#Per? fixat que hem fet els calculs tan per <130 com per <100, 
#per tant la definici? correcta es que tinguin o no MCV (si la tenen es PS i si no es PP).
#? BOGDAN......................................................................................
#
#
#
#

############################################################################################################################


```

## 4. Salvar tabla plana

```{r salvar}

saveRDS(dt_plana, file=here::here(params$dir_dades_desti,"dt_plana2.rds"))

```

```

&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>

